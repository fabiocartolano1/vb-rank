name: Migrate Dev to Prod

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Tapez "CONFIRMER" pour lancer la migration'
        required: true
        type: string

jobs:
  migrate-dev-to-prod:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "CONFIRMER" ]; then
            echo "::error::‚ùå Migration annul√©e. Vous devez taper 'CONFIRMER' pour lancer la migration."
            exit 1
          fi
          echo "‚úÖ Confirmation valid√©e"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Setup service account files
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV }}' > service-account-dev.json
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}' > service-account-prod.json

      - name: Create logs directory
        run: mkdir -p logs

      - name: Run migration (Dev to Prod with Admin SDK)
        run: |
          echo "üöÄ D√©marrage de la migration DEV vers PROD avec Admin SDK..."
          echo "oui" | npm run migrate:dev-to-prod:admin

      - name: Cleanup service account files
        if: always()
        run: |
          rm -f service-account-dev.json service-account-prod.json

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: migrate-dev-to-prod-logs-${{ github.run_id }}
          path: logs/*.log
          retention-days: 30

      - name: Migration Success
        if: success()
        run: |
          echo "::notice::‚úÖ Migration DEV vers PROD termin√©e avec succ√®s!"

      - name: Migration Failed
        if: failure()
        run: |
          echo "::error::‚ùå La migration DEV vers PROD a √©chou√©. Consultez les logs dans les artifacts."
          exit 1
